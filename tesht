#!/usr/bin/env bash

Main() {
  local File TestFiles=()
  for File in ${Files[*]}; do
    [[ $File == *_test.bash ]] && TestFiles+=( $File )
  done

  (( ${#TestFiles[*]} > 0 )) || { echo "no test files found"; exit 1; }

  for File in ${TestFiles[*]}; do
    Test $File
  done
}

ListTestFuncs() { (
  local Func
  for Func in $(source $1; declare -F); do
    Func=${Func#declare -f }
    [[ $Func == Test[_A-Z]* ]] && echo $Func
  done
) }

Test() {
  local File=$1 Func
  for Func in $(ListTestFuncs $1); do
    ( source $1; $Func )
  done
}

return 2>/dev/null

[[ ${1:-} == -x ]] && { shift; set -x; }
IFS=$'\n'
Files=( ${1:-}${1:+/}* )
set -euf

Main "$@"
