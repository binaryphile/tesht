#!/usr/bin/env bash

Main() {
  local File TestFiles=()
  for File in ${Files[*]}; do
    [[ $File == *_test.bash ]] && TestFiles+=( $File )
  done

  (( ${#TestFiles[*]} > 0 )) || { echo "no test files found"; exit; }

  for File in ${TestFiles[*]}; do
    echo "=== RUN   ${File%.bash}"
    Test "$File" && echo PASS || echo FAIL
  done
}

ListTestFuncs() {
  local Func
  for Func in $(source $1; declare -F); do
    Func=${Func#declare -f }
    [[ $Func == Test_[_A-Z]* ]] && echo $Func
  done
}

Test() {
  local File=$1 Func Failed=0

  for Func in $(ListTestFuncs $File); do
    echo "=== RUN   $Func"

    local Duration Output Rc
    SECONDS=0
    Output=$(source $File; $Func) && Rc=$? || Rc=$?
    Duration=$SECONDS

    (( Rc == 0 )) && { echo "--- PASS: $Func (${Duration}s)"; continue; }

    echo "--- FAIL: $Func (${Duration}s)"
    echo "$Output"
    Failed=1
  done

  return $Failed
}

IFS=$'\n'
Files=( ${1:-}${1:+/}* )
set -euf

Main "$@"
